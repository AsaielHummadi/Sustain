@model Sustain.Models.SubscriptionPlan
@{
    ViewData["Title"] = "Subscription Checkout";
    Layout = "~/Views/Shared/_AppLayout.cshtml";
}

<div class="container py-5 my-md-5">
    <div class="row">
        <div class="col-12">
            <h1 class="fw-bold mb-5 text-center text-md-start">
                @if (Model.SubscriptionPlanType == "free")
                {
                    @:Start Your Free Trial
                }
                else
                {
                    @:Secure Subscription Checkout
                }
            </h1>
        </div>
    </div>

    <form method="POST" asp-action="ProcessSubscription" id="subscriptionForm">
        @Html.AntiForgeryToken()
        <input type="hidden" name="SubscriptionPlanId" value="@Model.SubscriptionPlanId">

        <div class="checkout-container">
            <!-- LEFT COLUMN: Forms -->
            <div class="form-sections">
                <!-- Organization Information -->
                <div class="form-card">
                    <h3 class="fw-bold mb-4 d-flex align-items-center text-dark">
                        <i class="bi bi-briefcase-fill me-3 fs-3 iColor"></i> Organization Information
                    </h3>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <label for="OrganizationName" class="form-label fw-semibold">Organization Name</label>
                            <input type="text" class="form-control @(ViewData.ModelState["OrganizationName"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                   id="OrganizationName" name="OrganizationName"
                                   value="@ViewData["OrganizationName"]"
                                   placeholder="Enter Organization Name" required>
                            @if (ViewData.ModelState["OrganizationName"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback">@ViewData.ModelState["OrganizationName"].Errors[0].ErrorMessage</div>
                            }
                        </div>
                        <div class="col-md-6">
                            <label for="OrganizationIndustry" class="form-label fw-semibold">Industry</label>
                            <select class="form-select @(ViewData.ModelState["OrganizationIndustry"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                    id="OrganizationIndustry" name="OrganizationIndustry" required>
                                <option value="">Choose Industry</option>
                                <option value="Petrochemicals" selected="@(ViewData["OrganizationIndustry"]?.ToString() == "Petrochemicals")">Petrochemicals</option>
                                <option value="Manufacturing" selected="@(ViewData["OrganizationIndustry"]?.ToString() == "Manufacturing")">Manufacturing</option>
                                <option value="Logistics" selected="@(ViewData["OrganizationIndustry"]?.ToString() == "Logistics")">Logistics</option>
                                <option value="Other" selected="@(ViewData["OrganizationIndustry"]?.ToString() == "Other")">Other</option>
                            </select>
                            @if (ViewData.ModelState["OrganizationIndustry"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback">@ViewData.ModelState["OrganizationIndustry"].Errors[0].ErrorMessage</div>
                            }
                        </div>
                        <div class="col-md-6">
                            <label for="OrganizationCity" class="form-label fw-semibold">City</label>
                            <select class="form-select @(ViewData.ModelState["OrganizationCity"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                    id="OrganizationCity" name="OrganizationCity" required>
                                <option value="">Choose City</option>
                                <option value="Riyadh" selected="@(ViewData["OrganizationCity"]?.ToString() == "Riyadh")">Riyadh</option>
                                <option value="Jeddah" selected="@(ViewData["OrganizationCity"]?.ToString() == "Jeddah")">Jeddah</option>
                                <option value="Dammam" selected="@(ViewData["OrganizationCity"]?.ToString() == "Dammam")">Dammam</option>
                                <option value="Jubail" selected="@(ViewData["OrganizationCity"]?.ToString() == "Jubail")">Jubail</option>
                                <option value="Other" selected="@(ViewData["OrganizationCity"]?.ToString() == "Other")">Other</option>
                            </select>
                            @if (ViewData.ModelState["OrganizationCity"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback">@ViewData.ModelState["OrganizationCity"].Errors[0].ErrorMessage</div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Administrator Account -->
                <div class="form-card">
                    <h3 class="fw-bold mb-4 d-flex align-items-center text-dark">
                        <i class="bi bi-person-circle me-3 fs-3 iColor"></i> Administrator Account
                    </h3>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <label for="UserFname" class="form-label fw-semibold">First Name</label>
                            <input type="text" class="form-control @(ViewData.ModelState["UserFname"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                   id="UserFname" name="UserFname"
                                   value="@ViewData["UserFname"]"
                                   placeholder="e.g. Ahmed" required>
                            @if (ViewData.ModelState["UserFname"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback">@ViewData.ModelState["UserFname"].Errors[0].ErrorMessage</div>
                            }
                        </div>
                        <div class="col-md-6">
                            <label for="UserLname" class="form-label fw-semibold">Last Name</label>
                            <input type="text" class="form-control @(ViewData.ModelState["UserLname"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                   id="UserLname" name="UserLname"
                                   value="@ViewData["UserLname"]"
                                   placeholder="e.g. Almusai" required>
                            @if (ViewData.ModelState["UserLname"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback">@ViewData.ModelState["UserLname"].Errors[0].ErrorMessage</div>
                            }
                        </div>
                        <div class="col-md-6">
                            <label for="UserEmail" class="form-label fw-semibold">Email</label>
                            <input type="email" class="form-control @(ViewData.ModelState["UserEmail"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                   id="UserEmail" name="UserEmail"
                                   value="@ViewData["UserEmail"]"
                                   placeholder="ahmed@company.com" required>
                            @if (ViewData.ModelState["UserEmail"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback">@ViewData.ModelState["UserEmail"].Errors[0].ErrorMessage</div>
                            }
                        </div>
                        <div class="col-md-6">
                            <label for="UserPhone" class="form-label fw-semibold">Phone</label>
                            <input type="text" class="form-control @(ViewData.ModelState["UserPhone"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                   id="UserPhone" name="UserPhone"
                                   value="@ViewData["UserPhone"]"
                                   placeholder="+966 5X XXX XXXX">
                            @if (ViewData.ModelState["UserPhone"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback">@ViewData.ModelState["UserPhone"].Errors[0].ErrorMessage</div>
                            }
                        </div>
                        <div class="col-md-6">
                            <label for="UserPassword" class="form-label fw-semibold">Password</label>
                            <input type="password" class="form-control @(ViewData.ModelState["UserPassword"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                   id="UserPassword" name="UserPassword" required>
                            @if (ViewData.ModelState["UserPassword"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback">@ViewData.ModelState["UserPassword"].Errors[0].ErrorMessage</div>
                            }
                        </div>
                        <div class="col-md-6">
                            <label for="UserPasswordConfirmation" class="form-label fw-semibold">Confirm Password</label>
                            <input type="password" class="form-control @(ViewData.ModelState["UserPasswordConfirmation"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                   id="UserPasswordConfirmation" name="UserPasswordConfirmation" required>
                            @if (ViewData.ModelState["UserPasswordConfirmation"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback">@ViewData.ModelState["UserPasswordConfirmation"].Errors[0].ErrorMessage</div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Payment Details (Only for paid plans) -->
                <div class="form-card payment-section" id="paymentSection">
                    <h3 class="fw-bold mb-4 d-flex align-items-center text-dark">
                        <i class="bi bi-credit-card me-3 fs-3 iColor"></i> Payment Details
                    </h3>

                    <div class="card-logos">
                        <img height="150px" src="~/pay.png" alt="Payment Methods">
                    </div>

                    <div class="mb-3">
                        <label for="CardNumber" class="form-label">Card Number</label>
                        <input type="text" class="form-control @(ViewData.ModelState["CardNumber"]?.Errors.Count > 0 ? "is-invalid" : "")"
                               id="CardNumber" name="CardNumber"
                               value="@ViewData["CardNumber"]"
                               placeholder="XXXX XXXX XXXX XXXX"
                               data-required-if="paid">
                        @if (ViewData.ModelState["CardNumber"]?.Errors.Count > 0)
                        {
                            <div class="invalid-feedback">@ViewData.ModelState["CardNumber"].Errors[0].ErrorMessage</div>
                        }
                    </div>

                    <div class="row mb-4 g-3">
                        <div class="col-6">
                            <label for="ExpiryDate" class="form-label">Expiry Date</label>
                            <input type="text" class="form-control @(ViewData.ModelState["ExpiryDate"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                   id="ExpiryDate" name="ExpiryDate"
                                   value="@ViewData["ExpiryDate"]"
                                   placeholder="MM/YY"
                                   data-required-if="paid">
                            @if (ViewData.ModelState["ExpiryDate"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback">@ViewData.ModelState["ExpiryDate"].Errors[0].ErrorMessage</div>
                            }
                        </div>
                        <div class="col-6">
                            <label for="Cvc" class="form-label">CVC</label>
                            <input type="text" class="form-control @(ViewData.ModelState["Cvc"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                   id="Cvc" name="Cvc"
                                   value="@ViewData["Cvc"]"
                                   placeholder="123"
                                   data-required-if="paid">
                            @if (ViewData.ModelState["Cvc"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback">@ViewData.ModelState["Cvc"].Errors[0].ErrorMessage</div>
                            }
                        </div>
                    </div>

                    <p class="small text-muted mb-4">
                        @if (Model.SubscriptionPlanType == "free")
                        {
                            @:Your free trial starts immediately. No payment required.
                        }
                        else
                        {
                            @:By continuing, you agree to our Terms of Service. The charge will be processed immediately.
                        }
                    </p>
                </div>
            </div>

            <!-- RIGHT COLUMN: Order Summary -->
            <div class="payment-summary">
                <!-- Plan Summary Card -->
                <div class="order-summary-card mb-4">
                    <h4 class="fw-bold text-dark mb-3">@Model.SubscriptionPlanName Plan: Summary</h4>

                    @if (Model.SubscriptionPlanType == "free")
                    {
                        <h2 class="fw-bolder mb-3" style="color: var(--dark-green);">
                            FREE<span class="fs-6 fw-normal">/month trial</span>
                        </h2>
                    }
                    else
                    {
                        <h2 class="fw-bolder mb-3" style="color: var(--dark-green);">
                            @Model.SubscriptionPlanPrice?.ToString("N0") SAR<span class="fs-6 fw-normal">/yr</span>
                        </h2>
                    }

                    <hr>

                    <ul class="list-unstyled mb-4 small">
                        <li class="mb-2 d-flex align-items-start"><i class="bi bi-check-lg me-2 mt-1"></i> Track Emission sources</li>
                        <li class="mb-2 d-flex align-items-start"><i class="bi bi-check-lg me-2 mt-1"></i> Request custom Emission sources</li>
                        <li class="mb-2 d-flex align-items-start"><i class="bi bi-check-lg me-2 mt-1"></i> Save activity data</li>
                        <li class="mb-2 d-flex align-items-start"><i class="bi bi-check-lg me-2 mt-1"></i> Automatic GHG calculations</li>
                        <li class="mb-2 d-flex align-items-start"><i class="bi bi-check-lg me-2 mt-1"></i> Generate sustainability reports</li>
                        <li class="mb-2 d-flex align-items-start"><i class="bi bi-check-lg me-2 mt-1"></i> Real-time performance dashboards</li>
                        <li class="mb-2 d-flex align-items-start"><i class="bi bi-check-lg me-2 mt-1"></i> Users: up to @Model.SubscriptionPlanUserMax users</li>
                        <li class="mb-2 d-flex align-items-start"><i class="bi bi-check-lg me-2 mt-1"></i> Factories: up to @Model.SubscriptionPlanFactoryMax factories</li>
                        @if (Model.SubscriptionPlanType == "free")
                        {
                            <li class="mb-2 d-flex align-items-start"><i class="bi bi-check-lg me-2 mt-1"></i> One month free trial</li>
                        }
                    </ul>

                    <button type="submit" class="btn btn-dark-green w-100 py-3 rounded-3 fw-bold">
                        @if (Model.SubscriptionPlanType == "free")
                        {
                            @:Start Free Trial
                        }
                        else
                        {
                            @:Subscribe Now
                        }
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

@section Styles {
    <style>
        .form-card {
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .form-control, .form-select {
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            border-color: #ccc;
        }

        .order-summary-card {
            border: 2px solid var(--dark-green);
            border-radius: 1rem;
            background-color: white;
            padding: 2rem;
        }

            .order-summary-card .bi-check-lg {
                color: var(--accent-green);
                font-weight: bold;
            }

        .card-logos {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

            .card-logos img {
                width: 100%;
            }

        .payment-section {
            display: @(Model.SubscriptionPlanType == "paid" && Model.SubscriptionPlanPrice > 0 ? "block" : "none");
        }

        @@media (min-width: 992px) {
            .checkout-container {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 3rem;
            }
        }
    </style>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const planType = '@Model.SubscriptionPlanType';
            const paymentSection = document.getElementById('paymentSection');

            // Show/hide payment section based on plan type
            if (planType === 'free') {
                if (paymentSection) {
                    paymentSection.style.display = 'none';
                }
            }

            // Form validation
            document.getElementById('subscriptionForm').addEventListener('submit', function(e) {
                let isValid = true;
                const errorMessages = [];

                if (planType === 'paid') {
                    const cardNumber = document.getElementById('CardNumber').value.replace(/\s/g, '');
                    const expiryDate = document.getElementById('ExpiryDate').value;
                    const cvc = document.getElementById('Cvc').value;

                    // Card number validation (16 digits)
                    if (!cardNumber) {
                        errorMessages.push('Card number is required');
                        isValid = false;
                    } else if (!/^\d{16}$/.test(cardNumber)) {
                        errorMessages.push('Card number must be 16 digits');
                        isValid = false;
                    }

                    // Expiry date validation (MM/YY format)
                    if (!expiryDate) {
                        errorMessages.push('Expiry date is required');
                        isValid = false;
                    } else if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiryDate)) {
                        errorMessages.push('Expiry date must be in MM/YY format');
                        isValid = false;
                    } else {
                        // Check if card is expired
                        const [month, year] = expiryDate.split('/');
                        const currentDate = new Date();
                        const currentYear = currentDate.getFullYear() % 100;
                        const currentMonth = currentDate.getMonth() + 1;

                        if (parseInt(year) < currentYear ||
                            (parseInt(year) === currentYear && parseInt(month) < currentMonth)) {
                            errorMessages.push('Card has expired');
                            isValid = false;
                        }
                    }

                    // CVC validation (3 or 4 digits)
                    if (!cvc) {
                        errorMessages.push('CVC is required');
                        isValid = false;
                    } else if (!/^\d{3,4}$/.test(cvc)) {
                        errorMessages.push('CVC must be 3 or 4 digits');
                        isValid = false;
                    }
                }

                if (!isValid) {
                    e.preventDefault();
                    alert('Please fix the following errors:\n\n' + errorMessages.join('\n'));
                    return false;
                }
            });

            // Real-time validation for payment fields
            if (planType === 'paid') {
                // Format card number as user types
                document.getElementById('CardNumber').addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
                    if (value.length > 16) value = value.substring(0, 16);

                    // Add spaces every 4 digits
                    value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
                    e.target.value = value;
                });

                // Format expiry date as user types
                document.getElementById('ExpiryDate').addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 4) value = value.substring(0, 4);

                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2);
                    }
                    e.target.value = value;
                });

                // Only allow numbers for CVC
                document.getElementById('Cvc').addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/\D/g, '');
                });
            }
        });
    </script>
}