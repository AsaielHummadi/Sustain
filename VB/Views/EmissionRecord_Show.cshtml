@model Sustain.ViewModels.EmissionRecordVMs.EmissionRecordShowViewModel
@{
    ViewData["Title"] = "Emission Record Details";
    Layout = "~/Views/Shared/_AppLayout.cshtml";
}

<div class="container-fluid p-4 p-md-5">
    <!-- Back Button -->
    <div class="row mb-4">
        <div style="justify-content: flex-end;" class="col-12 d-flex flex-start">
            <a href="@Url.Action("Index")" class="btn btn-danger btn-sm mb-3 px-3 py-2 rounded-3">
                Back to All Records <i class="bi bi-arrow-right ms-2"></i>
            </a>
        </div>
    </div>

    <!-- Emission Record Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm btn-dark-green text-white">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-cloud-arrow-up me-3 fs-2"></i>
                                <div>
                                    <h1 class="h2 fw-bold mb-1">@Model.EmissionRecord.EmissionSource?.EmissionSourceName</h1>
                                    <p class="mb-0 opacity-90">@Model.EmissionRecord.EmissionSource?.EmissionSourceDescription</p>
                                </div>
                            </div>
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                <span class="badge bg-white text-dark fs-6 px-3 py-2">
                                    <i class="bi bi-building me-1"></i>
                                    @Model.EmissionRecord.Factory?.FactoryName
                                </span>
                                <span class="badge bg-white text-dark fs-6 px-3 py-2">
                                    <i class="bi bi-calendar me-1"></i>
                                    @(new DateTime(Model.EmissionRecord.EmissionYear, Model.EmissionRecord.EmissionMonth, 1).ToString("MMMM yyyy"))
                                </span>
                                <span class="badge
                                    @(Model.EmissionRecord.EmissionSource?.EmissionSourceScope == "Scope 1" ? "bg-warning" :
                                                                            Model.EmissionRecord.EmissionSource?.EmissionSourceScope == "Scope 2" ? "bg-info" : "bg-secondary")
                                    text-dark fs-6 px-3 py-2">
                                    <i class="bi bi-diagram-3 me-1"></i>
                                    @Model.EmissionRecord.EmissionSource?.EmissionSourceScope
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="rounded-3 p-3 text-white">
                                <div class="text-center">
                                    <div class="h1 fw-bold text-white mb-1">@Model.Emissions.ToString("N3")</div>
                                    <div class="text-white">tCO₂e Emissions</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Left Column - Details & Calculation -->
        <div class="col-lg-8">
            <!-- Emission Details -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3 border-bottom">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-info-circle me-2 text-primary"></i>Emission Details
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-item mb-4">
                                <small class="text-muted d-block">Activity Data</small>
                                <div class="h4 fw-bold text-primary">
                                    @Model.EmissionRecord.EmissionQuantity?.ToString("N2")
                                    <small class="fs-6 text-muted">@Model.EmissionRecord.EmissionSource?.EmissionSourceUnit</small>
                                </div>
                                <small class="text-muted">Raw consumption quantity</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-item mb-4">
                                <small class="text-muted d-block">Emission Factor</small>
                                <div class="h4 fw-bold text-info">
                                    @(Model.EmissionRecord.EmissionSource?.EmissionSourceEmissionFactor?.ToString("N6") ?? "0.000000")
                                    <small class="fs-6 text-muted">kg CO₂e/@Model.EmissionRecord.EmissionSource?.EmissionSourceUnit</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Calculation Breakdown -->
                    <div class="calculation-breakdown bg-light rounded-3 p-4">
                        <h6 class="fw-semibold mb-3 text-dark">
                            <i class="bi bi-calculator me-2"></i>GHG Protocol Calculation
                        </h6>
                        <div class="calculation-steps">
                            <div class="step mb-3">
                                <div class="d-flex align-items-center">
                                    <span class="step-number bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center me-3">1</span>
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold">Activity Data × Emission Factor</div>
                                        <div class="text-muted small">
                                            @Model.EmissionRecord.EmissionQuantity?.ToString("N2")
                                            ×
                                            @(Model.EmissionRecord.EmissionSource?.EmissionSourceEmissionFactor?.ToString("N6") ?? "0.000000")
                                            =
                                            @((Model.EmissionRecord.EmissionQuantity * (Model.EmissionRecord.EmissionSource?.EmissionSourceEmissionFactor ?? 0))?.ToString("N2")) kg CO₂e
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="step">
                                <div class="d-flex align-items-center">
                                    <span class="step-number bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center me-3">2</span>
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold">Convert to tonnes</div>
                                        <div class="text-muted small">
                                            @((Model.EmissionRecord.EmissionQuantity * (Model.EmissionRecord.EmissionSource?.EmissionSourceEmissionFactor ?? 0))?.ToString("N2")) kg CO₂e ÷ 1000
                                            =
                                            <strong class="text-primary">@Model.Emissions.ToString("N3") tCO₂e</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scope Information -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 border-bottom">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-diagram-3 me-2 text-primary"></i>Scope Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Scope 1 -->
                        <div class="col-md-4">
                            <div class="scope-card @(Model.EmissionRecord.EmissionSource?.EmissionSourceScope == "Scope 1" ? "active-scope" : "") text-center p-3 rounded-3">
                                <div class="scope-icon mb-2">
                                    <i class="bi bi-fuel-pump fs-1 @(Model.EmissionRecord.EmissionSource?.EmissionSourceScope == "Scope 1" ? "text-warning" : "text-muted")"></i>
                                </div>
                                <h6 class="fw-semibold @(Model.EmissionRecord.EmissionSource?.EmissionSourceScope == "Scope 1" ? "text-warning" : "text-muted")">
                                    Scope 1
                                </h6>
                                <p class="small text-muted mb-0">
                                    Direct emissions from owned sources
                                </p>
                            </div>
                        </div>

                        <!-- Scope 2 -->
                        <div class="col-md-4">
                            <div class="scope-card @(Model.EmissionRecord.EmissionSource?.EmissionSourceScope == "Scope 2" ? "active-scope" : "") text-center p-3 rounded-3">
                                <div class="scope-icon mb-2">
                                    <i class="bi bi-lightning-charge fs-1 @(Model.EmissionRecord.EmissionSource?.EmissionSourceScope == "Scope 2" ? "text-info" : "text-muted")"></i>
                                </div>
                                <h6 class="fw-semibold @(Model.EmissionRecord.EmissionSource?.EmissionSourceScope == "Scope 2" ? "text-info" : "text-muted")">
                                    Scope 2
                                </h6>
                                <p class="small text-muted mb-0">
                                    Indirect emissions from purchased electricity
                                </p>
                            </div>
                        </div>

                        <!-- Scope 3 - Coming Soon -->
                        <div class="col-md-4">
                            <div class="scope-card text-center p-3 rounded-3">
                                <div class="scope-icon mb-2">
                                    <i class="bi bi-truck fs-1 text-muted opacity-50"></i>
                                </div>
                                <h6 class="fw-semibold text-muted">
                                    Scope 3
                                </h6>
                                <p class="small text-muted mb-0">
                                    Other indirect emissions
                                </p>
                                <span class="badge bg-secondary mt-2">Coming Soon</span>
                            </div>
                        </div>
                    </div>

                    <!-- Scope Description -->
                    <div class="mt-4 p-3 bg-light rounded-3">
                        <h6 class="fw-semibold mb-2">About @Model.EmissionRecord.EmissionSource?.EmissionSourceScope</h6>
                        <p class="text-muted small mb-0">
                            @if (Model.EmissionRecord.EmissionSource?.EmissionSourceScope == "Scope 1")
                            {
                                <text><strong>Direct emissions</strong> from sources that are owned or controlled by your organization, such as fuel combustion in vehicles, boilers, and furnaces.</text>
                            }
                            else if (Model.EmissionRecord.EmissionSource?.EmissionSourceScope == "Scope 2")
                            {
                                <text><strong>Indirect emissions</strong> from the generation of purchased electricity, steam, heating, and cooling that is consumed by your organization.</text>
                            }
                            else
                            {
                                <text>Scope information not available.</text>
                            }
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Context & Actions -->
        <div class="col-lg-4">
            <!-- Record Information -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3 border-bottom">
                    <h5 class="mb-0 text-dark">
                        <i class="bi bi-card-checklist me-2 text-primary"></i>Record Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="info-item mb-3">
                        <small class="text-muted d-block">Entered By</small>
                        <div class="fw-semibold">
                            <i class="bi bi-person me-2"></i>
                            @Model.EmissionRecord.User?.UserFname @Model.EmissionRecord.User?.UserLname
                        </div>
                    </div>
                    <div class="info-item mb-3">
                        <small class="text-muted d-block">Entry Date</small>
                        <div class="fw-semibold">
                            <i class="bi bi-calendar-event me-2"></i>
                            @Model.EmissionRecord.EmissionCreatedAt?.ToString("MMMM dd, yyyy")
                        </div>
                    </div>
                    <div class="info-item mb-3">
                        <small class="text-muted d-block">Last Updated</small>
                        <div class="fw-semibold">
                            <i class="bi bi-clock me-2"></i>
                            @Model.EmissionRecord.EmissionUpdatedAt?.ToString("MMMM dd, yyyy")
                        </div>
                    </div>
                    <div class="info-item">
                        <small class="text-muted d-block">Organization</small>
                        <div class="fw-semibold">
                            <i class="bi bi-building me-2"></i>
                            @Model.EmissionRecord.Organization?.OrganizationName
                        </div>
                    </div>
                </div>
            </div>

            <!-- Similar Records -->
            @if (Model.SimilarRecords.Count > 0)
            {
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h5 class="mb-0 text-dark">
                            <i class="bi bi-clock-history me-2 text-primary"></i>Recent Similar Records
                        </h5>
                    </div>
                    <div class="card-body">
                        @foreach (var similar in Model.SimilarRecords)
                        {
                            <div class="similar-record mb-3 pb-3 border-bottom">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="fw-semibold small">
                                            @(new DateTime(similar.EmissionYear, similar.EmissionMonth, 1).ToString("MMM yyyy"))
                                        </div>
                                        <div class="text-muted smaller">
                                            @similar.Factory?.FactoryName
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-semibold text-primary small">
                                            @similar.EmissionQuantity?.ToString("N0")
                                        </div>
                                        <div class="text-muted smaller">
                                            @similar.EmissionSource?.EmissionSourceUnit
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        <a href="@Url.Action("Index", new { source = Model.EmissionRecord.EmissionSourceId })"
                           class="btn btn-outline-secondary btn-sm w-100">
                            View All @Model.EmissionRecord.EmissionSource?.EmissionSourceName Records
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <style>
        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }

        .scope-card {
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .active-scope {
            border-color: var(--dark-green);
            background-color: rgba(26, 77, 46, 0.05);
        }

        .scope-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .calculation-breakdown {
            border-left: 4px solid var(--dark-green);
        }

        .step-number {
            width: 30px;
            height: 30px;
            font-size: 0.875rem;
            font-weight: bold;
        }

        .detail-item {
            padding: 1rem;
            border-radius: 0.5rem;
            background: #f8f9fa;
        }

        .info-item {
            padding: 0.75rem;
            border-radius: 0.5rem;
            background: #f8f9fa;
        }

        .similar-record:last-child {
            border-bottom: none !important;
            margin-bottom: 0 !important;
            padding-bottom: 0 !important;
        }

        .smaller {
            font-size: 0.75rem;
        }

        .card {
            border-radius: 1rem;
            border: none;
        }

        .btn-lg {
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
        }

        :root {
            --dark-green: #1a4d2e;
        }
    </style>
}